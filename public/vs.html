<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meltian fire it!</title>
  <link rel="stylesheet" href="vs.css">
  <script src="https://unpkg.com/alpinejs" defer></script>
</head>

<body>
  <div>
    <div class="backgraund1">
      <a href="/pages/home/home.html"><img src="/image/dialog.png" width="30px" height="30px" alt="sample"></a>
    </div>
    <div class="background2" >
      <div id="life-frame">
        <div id="life-bar"></div>
        <div id="life-mark"></div>
      </div>
      <b class="enemy_name" id="enemy_name" >
          雑魚クーラン
      </b>
      <div class="vs">
        <div class="enemy" style="text-align: center">
          <img id="image01" src="/image/snowman1.png" width="70%" alt="sample">
        </div>
      </div>
          <div class="meters-wrapper">
            <div class="meter-panel">
              <div class="meter">
                <img id="image02" src="image/gauge.png" width="80%" alt="sample">
                <img id="needle02" src="image/needle2.png" class="needle" width="40%">
              </div>
            </div>
            <div class="meter-panel">
              <div class="meter">
                <img id="image03" src="image/gauge1.png" width="80%" alt="sample">
                <img id="needle03" src="image/needle2.png" class="needle" width="40%">
              </div>
            </div>
          </div>
      <div class="position" >
        <div class="button1">
          <input type="image" id="button01" src="image/atk_button.png" onclick="attack()" width="100%" height="100%" alt="HPmeter">
        </div>
        <div class="button2" >
            <input type="image" id="button02" src="image/run_button.png"  onclick="escape()" width="100%" height="100%" alt="POWERmeter">
        </div>
      </div>
      <div id="text" class="box">
        <div>
            雑魚クーランが現れた！
        </div>
      </div>
    </div>
  </div>
  
</body>
<script type="text/javascript" >
  const uis={
    lifeBar   : document.getElementById('life-bar'),
    lifeMark  : document.getElementById('life-mark'),
    lifeFrame : document.getElementById('life-frame'),
    dialog    : document.getElementById('text'),
    enemyName : document.getElementById('enemy_name'),
    enemy     : document.getElementById("image01"),
    hpGuage   : document.getElementById("image02"),
    hpMeter   : document.getElementById("needle02"),
    atkGuage  : document.getElementById("image03"),
    atkMeter  : document.getElementById("needle03"),
    atkBtn    : document.getElementById("button01"),
    runBtn    : document.getElementById("button02")
  } 
  const enemyList=[
    {
      name:"雑魚クーラン",
      maxlife:922,
      atk:20,
      frequency:70,
      imgs:[
        ["image/enemy/zako/snowman1.png", "image/enemy/zako/snowman4.png"],
        ["image/enemy/zako/snowman2.png", "image/enemy/zako/snowman5.png"],
        ["image/enemy/zako/snowman3.png", "image/enemy/zako/snowman6.png"]
      ]
    },
    {
      name:"エアクーラン",
      maxlife:1365,
      atk:40,
      frequency:20,
      imgs:[
        ["image/enemy/air/air_coolern1.png", "image/enemy/air/air_coolern2.png"],
        ["image/enemy/air/air_coolern3.png", "image/enemy/air/air_coolern4.png"],
        ["image/enemy/air/air_coolern5.png", "image/enemy/air/air_coolern6.png"]
      ]
    },
    {
      name:"ボスクーラン",
      maxlife:2730,
      atk:100,
      frequency:10,
      imgs:[
        ["image/enemy/boss/boss_coolern1.png", "image/enemy/boss/boss_coolern2.png"],
        ["image/enemy/boss/boss_coolern3.png", "image/enemy/boss/boss_coolern4.png"],
        ["image/enemy/boss/boss_coolern5.png", "image/enemy/boss/boss_coolern6.png"]
      ]
    },
    {
      name:"レアクーラン",
      maxlife:546,
      atk:10,
      frequency:0,
      imgs:[
        ["image/enemy/zako/snowman1.png", "image/enemy/zako/snowman4.png"],
        ["image/enemy/zako/snowman2.png", "image/enemy/zako/snowman5.png"],
        ["image/enemy/zako/snowman3.png", "image/enemy/zako/snowman6.png"]
      ]
    },
    {
      name:"ダミークーラン",
      maxlife:2500,
      atk:12,
      frequency:0,
      imgs:[
        ["image/enemy/zako/snowman1.png", "image/enemy/zako/snowman4.png"],
        ["image/enemy/zako/snowman2.png", "image/enemy/zako/snowman5.png"],
        ["image/enemy/zako/snowman3.png", "image/enemy/zako/snowman6.png"]
      ]
    }
  ]     
  const sum_freq = enemyList.reduce((sum, element) => sum + element.frequency, 0);
  const dec_atkGauge=5
  let enemy, enemy_status, maxlife_enemy, life_enemy, atk_enemy;
  let atk = 273, maxhp = 1000, hp = maxhp, atkGauge=70;
  let flag=true;

  function spawn(){
    //クーランガチャ
    let i = 0, j = sum_freq*Math.random();
    while(i<enemyList.length){
      j -= enemyList[i].frequency
      if(j<0) break;
      i++
    }
    //初期値の設定
    enemy=enemyList[i]
    enemy_status = 0
    maxlife_enemy = enemy.maxlife
    life_enemy = maxlife_enemy              
    atk_enemy = enemy.atk
    //レンダリング
    uis.enemyName.innerText=`${enemy.name}`
    uis.dialog.innerText = `${flag?"":"新たな"}${enemy.name}が現れた！`;
    if(flag)flag=false
    uis.enemy.src=enemy.imgs[enemy_status][0];
    uis.hpMeter.style.transform=`translate(-42%, 0%) rotate(${Math.floor(180 * (hp / maxhp))}deg)`;
    uis.atkMeter.style.transform=`translate(-42%, 0%) rotate(${Math.floor(180 * (atkGauge / 100))}deg)`;
    uis.lifeBar.style.width = "100%";
    uis.atkBtn.disabled = false;
    uis.runBtn.disabled = false;
    uis.enemyName.style.visibility='visible';
    uis.enemy.style.visibility='visible';
    uis.lifeFrame.style.visibility='visible';
  }
  spawn()
  if(hp<=0){
    uis.dialog.innerText="HPが足りない！\n回復して来よう！"
    uis.atkBtn.disabled = true;
    uis.runBtn.disabled = true;
    setTimeout(()=>history.back(-1),2000)
  }

  function attack(){
    //前処理
    if(atkGauge==0){
      let previous_msg=uis.dialog.innerText
      setTimeout(function(){
        uis.dialog.innerText = "アタックゲージが足りない・・・";
        uis.atkBtn.disabled = true;
        uis.runBtn.disabled = true;
      }, 1)
      setTimeout(function(){
        uis.dialog.innerText = previous_msg;
        uis.atkBtn.disabled = false;
        uis.runBtn.disabled = false;
      }, 1000)
      return;
    }
    atkGauge-=atkGauge<80?dec_atkGauge:0;
    if(atkGauge<0) atkGauge=0
    life_enemy-=atk;
    if(life_enemy<0) life_enemy=0
    else{
      hp-=atk_enemy;
      if(hp<0) hp=0
    }

    const lifePercentage_enemy=life_enemy/maxlife_enemy
    //アニメーション
    setTimeout(function(){
      uis.dialog.innerText = "攻撃をした!";
      uis.atkBtn.disabled = true;
      uis.runBtn.disabled = true;
      uis.atkGuage.style.filter="opacity(0.4) drop-shadow(0 0 0 blue)";
    }, 1)
    if(lifePercentage_enemy==0){
      setTimeout(function(){
        uis.atkMeter.style.transform=`translate(-42%, 0%) rotate(${Math.floor(180 * (atkGauge / 100))}deg)`;
        uis.atkGuage.style.filter="none";
        uis.enemy.src=enemy.imgs[enemy_status][1];
        uis.lifeBar.style.width = `${lifePercentage_enemy*100}%`;   
        uis.dialog.innerText = "敵を討伐した！";
      }, 1000) 
      setTimeout(function(){
        uis.enemyName.style.visibility = 'hidden';
        uis.lifeFrame.style.visibility = 'hidden';
        uis.enemy.style.visibility = 'hidden';
        uis.dialog.innerText = "おめでとう！君の勝利！";
      }, 2000) 
      setTimeout(spawn, 6000) 
    }
    else{
      setTimeout(function(){
        uis.enemy.src=enemy.imgs[enemy_status][1];
        uis.atkMeter.style.transform=`translate(-42%, 0%) rotate(${Math.floor(180 * (atkGauge / 100))}deg)`;
        uis.atkGuage.style.filter="none";
      }, 250) 
      setTimeout(function(){
        uis.lifeBar.style.width = `${lifePercentage_enemy*100}%`;
        if(lifePercentage_enemy>0.7)
          enemy_status=0
        else if(lifePercentage_enemy>0.2)
          enemy_status=1
        else
          enemy_status=2
      }, 500) 
      setTimeout(function(){
        uis.dialog.innerText = `${atk}kのダメージを与えた!`;
        uis.enemy.src=enemy.imgs[enemy_status][0];
      }, 1000) 
      setTimeout(function(){
        uis.dialog.innerText = "クーランが攻撃してきた!";
      }, 2000) 
      setTimeout(function(){
        uis.hpGuage.style.filter="opacity(0.4) drop-shadow(0 0 0 red)";
      }, 2250) 
      setTimeout(function(){
        uis.hpMeter.style.transform=`translate(-42%, 0%) rotate(${Math.floor(180 * (hp / maxhp))}deg)`;
        uis.hpGuage.style.filter="none";
        uis.dialog.innerText = `${atk_enemy}Kのダメージを受けた!`;
      },3000)
      if(hp==0){
        setTimeout(function(){
          uis.dialog.innerText = "負けてしまった・・・";
        },4000)
        setTimeout(()=>history.back(-1),6000)
      }
      else{
        setTimeout(function(){
          uis.atkBtn.disabled = false;
          uis.runBtn.disabled = false;
        }, 3000)
      }
    } 
  }
  function escape(){
    uis.atkBtn.disabled = true;
    uis.runBtn.disabled = true;
    uis.dialog.innerText = "逃げ出した！";
    uis.enemyName.style.visibility = 'hidden';
    uis.lifeFrame.style.visibility = 'hidden';
    uis.enemy.style.visibility = 'hidden';
    setTimeout(spawn, 3000) 
  }
</script>
</html>
